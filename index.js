require("dotenv").config();const e=require("express"),t=require("cors"),r=require("path"),{GoogleGenerativeAI:o}=require("@google/generative-ai"),n=require("express-rate-limit"),{Pool:a}=require("pg"),{registerFont:i,createCanvas:s}=require("canvas"),c=e(),l=process.env.PORT||3e3,d="gemini-2.5-flash",u=new Set;try{i(r.join(__dirname,"public","Moul.ttf"),{family:"Moul"})}catch(e){console.log("Font Err")}const m=new a({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}}),p=n({windowMs:288e5,max:10,message:{error:"Limit Exceeded"},keyGenerator:e=>e.ip,skip:e=>e.ip===process.env.OWNER_IP});c.set("trust proxy",1),c.use(t()),c.use(e.json()),c.use(e.static(r.join(__dirname,"public")));const f=`<script>!function(){setInterval(()=>{var e=new Date;debugger;new Date-e>100&&(document.body.innerHTML='<div style="background:#000;color:red;height:100vh;display:flex;justify-content:center;align-items:center;font-size:50px;font-weight:bold;">SYSTEM LOCKED</div>')},50);document.addEventListener("contextmenu",e=>e.preventDefault());document.addEventListener("keydown",e=>{if(123==e.keyCode||e.ctrlKey&&(85==e.keyCode||73==e.keyCode||74==e.keyCode))return e.preventDefault(),!1})}();</script><style>*{user-select:none;-webkit-user-select:none;cursor:default}</style>`;c.get("/",(e,t)=>{t.send(`<body style="background:#000;color:#0f0;display:flex;justify-content:center;align-items:center;height:100vh;font-family:monospace"><h1>SYSTEM ONLINE</h1>${f}</body>`)}),c.get("/stats",(e,t)=>t.json({users:u.size})),c.post("/api/generate-problem",p,async(e,t)=>{try{const{prompt:r}=e.body;if(!r)return t.sendStatus(400);u.add(e.ip);const n=new o(process.env.GEMINI_API_KEY).getGenerativeModel({model:d}),a=await n.generateContent(r);t.json({text:a.response.text()})}catch(e){t.sendStatus(500)}}),c.post("/api/leaderboard/submit",async(e,t)=>{const{username:r,score:o,difficulty:n}=e.body;try{const e=await m.connect();await e.query("INSERT INTO leaderboard(username,score,difficulty)VALUES($1,$2,$3)",[r.substring(0,25),o,n]),e.release(),t.json({success:!0})}catch(e){t.sendStatus(500)}}),c.get("/api/leaderboard/top",async(e,t)=>{try{const e=await m.connect(),r=await e.query("SELECT username,score,difficulty FROM leaderboard ORDER BY score DESC LIMIT 1000");e.release(),t.json(r.rows)}catch(e){t.sendStatus(500)}}),c.post("/api/submit-request",async(e,t)=>{const{username:r,score:o}=e.body;try{const e=await m.connect();await e.query("INSERT INTO certificate_requests(username,score,request_date)VALUES($1,$2,NOW())",[r,o]),e.release(),t.json({success:!0})}catch(e){t.sendStatus(500)}}),c.get("/admin/requests",async(e,t)=>{try{const e=await m.connect(),r=await e.query("SELECT * FROM certificate_requests ORDER BY request_date DESC LIMIT 50");e.release();let o=`${f}<table border="1" style="width:100%;border-collapse:collapse;font-family:sans-serif"><thead><tr style="background:#333;color:#fff"><th>ID</th><th>Name</th><th>Score</th><th>Action</th></tr></thead><tbody>`;r.rows.forEach(e=>{o+=`<tr><td>${e.id}</td><td><b>${e.username}</b></td><td>${e.score}</td><td><a href="/admin/generate-cert/${e.id}" target="_blank" style="color:blue;font-weight:bold">PRINT</a></td></tr>`}),t.send(o+"</tbody></table>")}catch(e){t.sendStatus(500)}}),c.get("/admin/generate-cert/:id",async(e,t)=>{try{const o=e.params.id,n=await m.connect(),a=await n.query("SELECT * FROM certificate_requests WHERE id=$1",[o]);if(n.release(),0===a.rows.length)return t.sendStatus(404);const{username:i,score:l,request_date:d}=a.rows[0],u=new Date(d),p=`ថ្ងៃទី ${u.getDate().toString().padStart(2,"0")} ខែ ${["មករា","កុម្ភៈ","មីនា","មេសា","ឧសភា","មិថុនា","កក្កដា","សីហា","កញ្ញា","តុលា","វិច្ឆិកា","ធ្នូ"][u.getMonth()]} ឆ្នាំ ${u.getFullYear()}`,g=2e3,y=1414,x=s(g,y),h=x.getContext("2d");h.fillStyle="#FFFFFF",h.fillRect(0,0,g,y),h.save(),h.translate(g/2,y/2),h.rotate(-Math.PI/6),h.font='bold 150px Arial',h.fillStyle="rgba(200,200,200,0.1)",h.textAlign="center",h.fillText("Math Quiz Pro",0,0),h.restore(),h.lineWidth=40,h.strokeStyle="#B45309",h.strokeRect(40,40,1920,1334),h.lineWidth=10,h.strokeStyle="#F59E0B",h.strokeRect(90,90,1820,1234),h.textAlign="center",h.fillStyle="#1E3A8A",h.font='70px "Moul"',h.fillText("លិខិតសរសើរ",1e3,300),h.font='40px "Moul"',h.fillStyle="#475569",h.fillText("ប្រគល់ជូនដោយសេចក្តីគោរពចំពោះ",1e3,400);const w=h.createLinearGradient(600,0,1400,0);w.addColorStop(0,"#854d0e"),w.addColorStop(.4,"#fde047"),w.addColorStop(.6,"#fef08a"),w.addColorStop(1,"#854d0e"),h.shadowColor="rgba(0,0,0,0.4)",h.shadowBlur=20,h.fillStyle=w,h.font='200px "Moul"',h.fillText(i,1e3,650),h.shadowBlur=0,h.fillStyle="#DC2626",h.font='bold 60px Arial',h.fillText(`ពិន្ទុសរុប: ${l}`,1e3,780),h.fillStyle="#334155",h.font='45px "Moul"';let S=920;h.fillText("ប្អូនបានបញ្ចេញសមត្ថភាព និងចូលរួមយ៉ាងសកម្មក្នុងការដោះស្រាយលំហាត់គណិតវិទ្យា",1e3,S),h.fillText("និងទទួលបានលទ្ធផលគួរជាទីមោទកៈ នៅលើគេហទំព័រ braintest.fun ។",1e3,S+80),h.fillStyle="#059669",h.fillText("សូមជូនពរឱ្យប្អូនបន្តភាពជោគជ័យ និងក្លាយជាធនធានមនុស្សដ៏ល្អ។",1e3,S+190),h.textAlign="right",h.fillStyle="#000",h.font="35px Arial",h.fillText(p,1750,1220),h.fillStyle="#0284c7",h.font='bold 35px Courier New',h.fillText("ទទួលបានពី: www.braintest.fun",1750,1280);const b=x.toBuffer("image/png");t.set("Content-Type","image/png"),t.send(b)}catch(e){console.error(e),t.sendStatus(500)}}),async function(){process.env.DATABASE_URL&&(await async function(){try{const e=await m.connect();await e.query("CREATE TABLE IF NOT EXISTS leaderboard(id SERIAL PRIMARY KEY,username VARCHAR(25) NOT NULL,score INTEGER NOT NULL,difficulty VARCHAR(15) NOT NULL,created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP)"),await e.query("CREATE TABLE IF NOT EXISTS certificate_requests(id SERIAL PRIMARY KEY,username VARCHAR(50) NOT NULL,score INTEGER NOT NULL,status VARCHAR(20) DEFAULT 'Pending',request_date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP)"),e.release()}catch(e){}}(),c.listen(l,()=>console.log("SERVER STARTED"))) }();
